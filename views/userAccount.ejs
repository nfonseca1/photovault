<% include partials/header.ejs %>

<script type="text/javascript" src="countries.js"></script>

<h3 id="userData" data-username="<%=user.username%>" data-userId="<%=user._id%>"><%=user.username%>'s Account</h3>
<div id="data" data-searched="no"></div>

<button class="btn btn-xs" id="followButton" style="<%if(!following){%>display: block;<%}else{%>display: none;<%}%>">Follow</button>
<button class="btn btn-xs" id="unfollowButton" style="<%if(following){%>display: block;<%}else{%>display: none;<%}%>">Unfollow</button>
<nav class="navbar navbar-expand-lg navbar-light bg-light" style="border: solid 1px #333333">
    <div class="navbar-nav">
        <a class="nav-item nav-link active" href="/account/<%=user.username%>">Photos <span class="sr-only">(current)</span></a>
        <a class="nav-item nav-link" href="/account/<%=user.username%>/following">Following</a>
        <a class="nav-item nav-link" href="/account/<%=user.username%>/followers">Followers</a>
    </div>
</nav>

<div class="jumbotron">
    <h2 class="display-4">Send a message</h2>
    <button id="msgFormButton" class="btn btn-primary btn-lg">Message</button>
</div>

<div id="msgForm" style="display: none;">
    <input type="text" class="form-control" id="msgText">
    <button type="button" class="btn btn-primary" id="msgSendButton">Send</button>
</div>

<hr>
<h3>Photos</h3>

<nav class="navbar navbar-expand-lg navbar-light bg-light" style="border: solid 1px #333333">
    <div class="form-group">
        <label for="sortBy">Sort By: </label>
        <select id="sortBy" name="sortBy" class="form-control">
            <option value="newest" selected="selected">Newest</option>
            <option value="highest rated">Highest Rated</option>
            <option value="most favorited">Most favorited</option>
            <option value="most viewed">Most Viewed</option>
        </select>
    </div>
    <div class="form-group">
        <label for="within">Within: </label>
        <select id="within" name="within" class="form-control">
            <option value="day">Past Day</option>
            <option value="week">Past Week</option>
            <option value="month" selected="selected">Past Month</option>
            <option value="year">Past Year</option>
            <option value="ever">Ever</option>
        </select>
    </div>
    <div class="form-group col">
        <label for="photoType">PhotoType: </label>
        <select id="photoType" name="photoType" class="form-control">
            <option value="any" selected="selected">Any</option>
            <option value="landscapes">Landscapes</option>
            <option value="cityscapes">Cityscapes</option>
        </select>
    </div>
    <div class="form-group col">
        <label for="sortBy">Country: </label>
        <select id="country" name="country" class="form-control">
            <option value="all" selected="selected">All</option>
        </select>
    </div>
    <button id="sortBtn" class="btn btn-xs btn-primary">Sort</button>
</nav>

<div id="grid" class="grid" data-posts="<%=htmlPosts.html%>" data-index="<%=htmlPosts.currentIndex%>">

</div>
<div id="endOfPage"></div>

<script>
    var followButton = document.querySelector("#followButton");
    var unfollowButton = document.querySelector("#unfollowButton");
    var msgFormButton = document.querySelector("#msgFormButton");
    var msgSendButton = document.querySelector("#msgSendButton")
    var msgForm = document.querySelector("#msgForm");
    var msgText = document.querySelector("#msgText");
    var formOn = false;

    followButton.addEventListener("click", function(){
        followButton.style.display = "none";
        unfollowButton.style.display = "block";

        axios.put("/api/users/follow", {
            accountUserId: userData.getAttribute("data-userId")
        })
    });

    unfollowButton.addEventListener("click", function(){
        unfollowButton.style.display = "none";
        followButton.style.display = "block";

        axios.put("/api/users/unfollow", {
            accountUserId: userData.getAttribute("data-userId")
        })
    });

    msgFormButton.addEventListener("click", function(){
        formOn = !formOn;
        if (formOn){
            msgForm.style.display = "block";
        } else {
            msgForm.style.display = "none";
        }
    });

    msgSendButton.addEventListener("click", function(){
        axios.get("/api/users/checkConversations", {
            params: {
                accountUserId: userData.getAttribute("data-userId")
            }
        }).then(function(res){
            if(res.data.existingConv){
                axios.put("/api/users/conversations", {
                    convId: res.data.convId,
                    text: msgText.value
                }).catch(function(err){console.log(err)})
            } else {
                axios.post("/api/users/conversations", {
                    accountUserId: userData.getAttribute("data-userId"),
                    text: msgText.value
                }).catch(function(err){console.log(err)})
            }
            msgText.value = "";
        }).catch(function(err){console.log(err)})
    });
</script>

<script type="text/javascript" src="postsSort.js"></script>

<script>
    document.addEventListener("scroll", function() {
        checkForNewDiv();
    });

    var checkForNewDiv = function() {
        var lastDiv = document.querySelector("#endOfPage");
        var lastDivOffset = lastDiv.offsetTop;
        var pageOffset = window.pageYOffset + window.innerHeight;
        sessionStorage.pagePosition = window.pageYOffset;

        if(pageOffset > lastDivOffset - 300 && !end && !wait) {
            wait = true;
            makeAJAXRequest({}, true);
        }
    };
</script>

<% include partials/footer.ejs %>