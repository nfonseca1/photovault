<% include partials/header.ejs %>

<h3><%=user.username%>'s Account</h3>
<div id="data" data-userId="<%=user._id%>"></div>
<button class="btn btn-xs" id="followButton" style="<%if(!following){%>display: block;<%}else{%>display: none;<%}%>">Follow</button>
<button class="btn btn-xs" id="unfollowButton" style="<%if(following){%>display: block;<%}else{%>display: none;<%}%>">Unfollow</button>
<nav class="navbar navbar-expand-lg navbar-light bg-light" style="border: solid 1px #333333">
    <div class="navbar-nav">
        <a class="nav-item nav-link active" href="/account">Photos <span class="sr-only">(current)</span></a>
        <a class="nav-item nav-link" href="#">Following</a>
        <a class="nav-item nav-link" href="#">Followers</a>
    </div>
</nav>

<div class="jumbotron">
    <h2 class="display-4">Send a message</h2>
    <button id="msgFormButton" class="btn btn-primary btn-lg">Message</button>
</div>

<div id="msgForm" style="display: none;">
    <input type="text" class="form-control" id="msgText">
    <button type="button" class="btn btn-primary" id="msgSendButton">Send</button>
</div>

<hr>
<h3>Photos</h3>

<div class="row text-center" style="display: flex; flex-wrap: wrap">
    <%posts.forEach(function(post){%>
    <div class="col-md-6">
        <a href="/home/<%= post._id %>" class="nostyle">
            <div class="thumbnail">
                <img src="<%= post.image %>">
            </div>
        </a>
    </div>
    <%});%>
</div>

<script>
    var data = document.querySelector("#data");
    var followButton = document.querySelector("#followButton");
    var unfollowButton = document.querySelector("#unfollowButton");
    var msgFormButton = document.querySelector("#msgFormButton");
    var msgSendButton = document.querySelector("#msgSendButton")
    var msgForm = document.querySelector("#msgForm");
    var msgText = document.querySelector("#msgText");
    var formOn = false;

    followButton.addEventListener("click", function(){
        followButton.style.display = "none";
        unfollowButton.style.display = "block";

        axios.put("/api/users/follow", {
            accountUserId: data.getAttribute("data-userId")
        })
    });

    unfollowButton.addEventListener("click", function(){
        unfollowButton.style.display = "none";
        followButton.style.display = "block";

        axios.put("/api/users/unfollow", {
            accountUserId: data.getAttribute("data-userId")
        })
    });

    msgFormButton.addEventListener("click", function(){
        formOn = !formOn;
        if (formOn){
            msgForm.style.display = "block";
        } else {
            msgForm.style.display = "none";
        }
    });

    msgSendButton.addEventListener("click", function(){
        axios.get("/api/users/checkConversations", {
            params: {
                accountUserId: data.getAttribute("data-userId")
            }
        }).then(function(res){
            if(res.data.existingConv){
                axios.put("/api/users/conversations", {
                    convId: res.data.convId,
                    text: msgText.value
                }).catch(function(err){console.log(err)})
            } else {
                axios.post("/api/users/conversations", {
                    accountUserId: data.getAttribute("data-userId"),
                    text: msgText.value
                }).catch(function(err){console.log(err)})
            }
            msgText.value = "";
        }).catch(function(err){console.log(err)})
    });

</script>

<% include partials/footer.ejs %>