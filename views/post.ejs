<% include partials/header.ejs %>

<div class="container">
    <div class="fullPost">
        <h2 class="text-center title"><%=post.title%></h2>
        <img src="<%=post.image%>" class="photo">
        <p class="description"><%=post.description%></p>
        <% if(currentUser && post.author.id.equals(currentUser._id)){%>
        <a class="btn btn-xs btn-warning" href="/home/<%=post._id%>/edit">Edit</a>
        <%}%>
    </div>
    <div>
        <h2>Comments</h2>
        <button id="addComment" class="btn btn-xs btn-success">Add Comment</button>
        <div id="commentArea">

        </div>
        <% post.comments.forEach(function(comment){ %>
        <div class="comment" data-comment-id="<%=comment._id%>" data-comment-text="<%=comment.text%>" style="background-color: #dddddd">
            <p>
                <%= comment.text %>
            </p>
            <button class="editComment" class="btn btn-xs btn-warning">Edit</button>
            <div>

            </div>
        </div>
        <%})%>
    </div>
</div>
<script>
    var commentArea = document.querySelector("#commentArea");
    var commentButton = document.querySelector("#addComment");
    var commentSections = document.querySelectorAll(".comment");
    var addFormOn = false;

    commentButton.addEventListener("click", openCommentForm);
    commentSections.forEach(function(commentSection) {
        commentSection.children[1].addEventListener("click", function(){
            var html = "";
            html += '<form action="/home/<%=post._id%>/comment/'+ commentSection.getAttribute('data-comment-id') +'?_method=PUT" method="POST" style="display: inline;">';
            html += '<input type="text" name="comment[text]" value="'+ commentSection.getAttribute('data-comment-text') +'">';
            html += '<button type="button" name="cancel" id="cancelComment" class="btn btn-xs">Cancel</button> ';
            html += '<button type="submit" class="btn btn-xs btn-warning" style="display: inline;">Update</button>';
            html += '</form> ';
            html += '<form action="/home/<%=post._id%>/comment/'+ commentSection.getAttribute('data-comment-id') + '?_method=DELETE" method="POST" style="display: inline;">';
            html += '<button type=submit class="btn btn-xs btn-danger">Delete</button>';
            html += '</form>';
            commentSection.children[0].style.display = "none";
            commentSection.children[1].style.display = "none";
            commentSection.children[2].innerHTML = html;
            var cancelComment = document.querySelector("#cancelComment");
            cancelComment.addEventListener("click", function(){
                commentSection.children[2].innerHTML = '';
                commentSection.children[0].style.display = "inline";
                commentSection.children[1].style.display = "block";
            })
        })
    });

    function openCommentForm(){
        var html = "";
        if(addFormOn) {
            commentArea.innerHTML = "";
            addFormOn = false;
        } else {
            html = '<form action="/home/<%= post._id %>" method="POST">';
            html += '<input type="text" class="form-control" name="comment[text]">';
            html += '<button type="submit" class="btn btn-xs btn-success">Post</button></form>';
            commentArea.innerHTML = html;
            addFormOn = true;
        }
    }
</script>
<% include partials/footer.ejs %>